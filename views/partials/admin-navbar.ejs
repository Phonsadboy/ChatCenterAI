<%
  const current = typeof activePage !== 'undefined' ? activePage : '';
  const signedInUser = typeof adminUser !== 'undefined' && adminUser ? adminUser : null;
  const roleBadgeLabel = signedInUser
    ? (signedInUser.role === 'superadmin' ? 'แอดมินใหญ่' : 'ผู้ดูแลระบบ')
    : '';
%>
<nav class="navbar navbar-expand-lg navbar-light app-navbar">
  <div class="container">
    <a class="navbar-brand" href="/admin/dashboard">
      <i class="fas fa-robot"></i> จัดการ AI
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item">
          <a class="nav-link<%= current === 'dashboard' ? ' active' : '' %>" href="/admin/dashboard">
            <i class="fas fa-tachometer-alt"></i> แดชบอร์ด
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link<%= current === 'broadcast' ? ' active' : '' %>" href="/admin/broadcast">
            <i class="fas fa-bullhorn"></i> บรอดแคสต์
          </a>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link<%= current === 'chat' ? ' active' : '' %>" href="/admin/chat">
            <i class="fas fa-comments"></i> แชท
            <span class="badge bg-danger notification-badge" id="chatNotificationBadge" style="display: none;">0</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link<%= current === 'orders' ? ' active' : '' %>" href="/admin/orders">
            <i class="fas fa-shopping-basket"></i> ออเดอร์
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link<%= current === 'followup' ? ' active' : '' %>" href="/admin/followup">
            <i class="fas fa-user-clock"></i> ติดตามลูกค้า
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link<%= current === 'facebook-comment' ? ' active' : '' %>" href="/admin/facebook-comment">
            <i class="fas fa-comment-dots"></i> ตอบคอมเมนต์ FB
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link<%= current === 'settings' ? ' active' : '' %>" href="/admin/settings">
            <i class="fas fa-cogs"></i> ตั้งค่า
          </a>
        </li>
        <% if (signedInUser) { %>
          <li class="nav-item d-flex align-items-center nav-user-pill">
            <span class="badge rounded-pill bg-light text-dark">
              <i class="fas fa-user-shield me-1 text-primary"></i>
              <%= roleBadgeLabel %>
              <% if (signedInUser.label) { %>
                <span class="text-muted">&middot; <%= signedInUser.label %></span>
              <% } %>
            </span>
          </li>
          <li class="nav-item">
            <button type="button" class="nav-link btn btn-link logout-link" id="adminLogoutBtn">
              <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
            </button>
          </li>
        <% } %>
      </ul>
    </div>
  </div>
</nav>
<script>
  (function() {
    window.adminAuth = window.adminAuth || {};
    window.adminAuth.requirePasscode = <%= isPasscodeRequired ? 'true' : 'false' %>;
    window.adminAuth.user = <%- JSON.stringify(signedInUser || null) %>;

    const logoutBtn = document.getElementById('adminLogoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async (event) => {
        event.preventDefault();
        logoutBtn.disabled = true;
        try {
          const response = await fetch('/admin/logout', { method: 'POST' });
          if (!response.ok) {
            throw new Error('logout_failed');
          }
          window.location.href = '/admin/login';
        } catch (error) {
          console.error('[Auth] logout error:', error);
          alert('ออกจากระบบไม่สำเร็จ กรุณาลองใหม่อีกครั้ง');
          logoutBtn.disabled = false;
        }
      });
    }
  })();
</script>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สถานะการติดตามลูกค้า</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/admin-navbar', { activePage: 'followup' }) %>

  <div class="container mt-4 mb-5">
    <%
      const overall = summary || {};
      const groupsData = Array.isArray(groups) ? groups : [];
      const nowTs = Date.now();
      let dueSoon = 0;
      let completedRounds = 0;
      const formatDateTime = (value) => {
        if (!value) return '-';
        try {
          return new Date(value).toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
        } catch (err) {
          return '-';
        }
      };
      const formatDelay = (minutes) => {
        const val = Number(minutes);
        if (!Number.isFinite(val) || val <= 0) return '-';
        if (val < 60) return `${val} นาที`;
        const hours = Math.floor(val / 60);
        const mins = val % 60;
        if (!mins) return `${hours} ชม.`;
        return `${hours} ชม. ${mins} นาที`;
      };
      const statusLabel = (status) => {
        switch (status) {
          case 'completed': return 'ส่งครบแล้ว';
          case 'canceled': return 'ยกเลิกแล้ว';
          case 'failed': return 'ส่งไม่สำเร็จ';
          default: return 'กำลังติดตาม';
        }
      };
      const statusBadgeClass = (status) => {
        switch (status) {
          case 'completed': return 'bg-success';
          case 'canceled': return 'bg-secondary';
          case 'failed': return 'bg-danger';
          default: return 'bg-warning text-dark';
        }
      };
      const statusIcon = (status) => {
        switch (status) {
          case 'completed': return 'fas fa-check-circle';
          case 'canceled': return 'fas fa-ban';
          case 'failed': return 'fas fa-exclamation-triangle';
          default: return 'fas fa-sync';
        }
      };
      groupsData.forEach(group => {
        (group.users || []).forEach(user => {
          if (user.status === 'active' && user.nextScheduledAt) {
            const diff = new Date(user.nextScheduledAt).getTime() - nowTs;
            if (diff >= 0 && diff <= 30 * 60000) {
              dueSoon += 1;
            }
          }
          if (user.status === 'completed') {
            const roundsCount = Array.isArray(user.rounds) ? user.rounds.length : (user.sentRounds || 0);
            completedRounds += roundsCount;
          }
        });
      });
    %>
    <div class="row justify-content-center">
      <div class="col-xl-11">
        <div class="card shadow-sm">
          <div class="card-body">
            <% if (typeof error !== 'undefined') { %>
              <div class="alert alert-danger mb-4"><%= error %></div>
            <% } %>

            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
              <div>
                <h5 class="mb-1"><i class="fas fa-chart-line me-2"></i> สถานะการติดตามลูกค้า</h5>
                <small class="text-muted">ข้อมูลประจำวันที่ <%= summaryLabel %></small>
              </div>
              <a href="/admin/followup" class="btn btn-outline-primary mt-3 mt-lg-0">
                <i class="fas fa-sliders-h me-1"></i> จัดการการตั้งค่าติดตาม
              </a>
            </div>

            <div class="row g-3 followup-summary-grid mb-4">
              <div class="col-sm-6 col-lg-3">
                <div class="followup-summary-card">
                  <div class="summary-label">กำลังติดตาม</div>
                  <div class="summary-value"><%= overall.active || 0 %></div>
                  <div class="summary-meta">ส่งใน 30 นาทีนี้ <%= dueSoon %> ราย</div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="followup-summary-card">
                  <div class="summary-label">ส่งครบแล้ว</div>
                  <div class="summary-value text-success"><%= overall.completed || 0 %></div>
                  <div class="summary-meta">รวมส่งแล้ว <%= completedRounds %> ข้อความ</div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="followup-summary-card">
                  <div class="summary-label">ยกเลิกแล้ว</div>
                  <div class="summary-value text-muted"><%= overall.canceled || 0 %></div>
                  <div class="summary-meta">ผู้ใช้กลับมาคุยก่อนเวลา</div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="followup-summary-card">
                  <div class="summary-label">ส่งไม่สำเร็จ</div>
                  <div class="summary-value text-danger"><%= overall.failed || 0 %></div>
                  <div class="summary-meta">ตรวจสอบการเชื่อมต่อหรือ Token</div>
                </div>
              </div>
            </div>

            <% if (!groupsData.length) { %>
              <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p class="mb-1">ยังไม่มีข้อมูลติดตามสำหรับวันนี้</p>
                <p class="small mb-0">ระบบจะเริ่มติดตามอัตโนมัติเมื่อมีการสนทนากับลูกค้า</p>
              </div>
            <% } %>

            <% groupsData.forEach(group => { %>
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
                  <div>
                    <h6 class="mb-1"><i class="fas fa-layer-group me-2"></i> <%= group.pageName %></h6>
                    <small class="text-muted">
                      แพลตฟอร์ม: <%= group.platform === 'facebook' ? 'Facebook' : 'LINE' %> • 
                      ส่งอัตโนมัติ: <%= group.config && group.config.autoFollowUpEnabled === false ? 'ปิด' : 'เปิด' %> • 
                      วิเคราะห์ด้วย AI: <%= group.config && group.config.analysisEnabled === false ? 'ปิด' : 'เปิด' %>
                    </small>
                  </div>
                  <div class="d-flex flex-wrap gap-2 mt-3 mt-lg-0">
                    <span class="badge bg-primary-soft text-primary">ทั้งหมด <%= group.stats.total || 0 %> ราย</span>
                    <span class="badge bg-success-soft text-success">กำลังติดตาม <%= group.stats.active || 0 %></span>
                    <span class="badge bg-secondary">ยกเลิก <%= group.stats.canceled || 0 %></span>
                    <span class="badge bg-danger">ส่งไม่สำเร็จ <%= group.stats.failed || 0 %></span>
                  </div>
                </div>
                <div class="card-body">
                  <div class="followup-config-preview mb-4">
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2">
                      <div>
                        <strong>แผนการส่งข้อความ</strong>
                        <div class="text-muted small">
                          <% if (group.config && group.config.autoFollowUpEnabled === false) { %>
                            ระบบจะไม่ส่งข้อความอัตโนมัติสำหรับเพจนี้
                          <% } else { %>
                            ระบบจะนับเวลาจากข้อความล่าสุดของลูกค้า
                          <% } %>
                        </div>
                      </div>
                      <span class="badge <%= group.config && group.config.autoFollowUpEnabled === false ? 'bg-secondary' : 'bg-success' %>">
                        <%= group.config && group.config.autoFollowUpEnabled === false ? 'ปิดการส่งอัตโนมัติ' : 'เปิดการส่งอัตโนมัติ' %>
                      </span>
                    </div>
                    <% if (group.config && group.config.autoFollowUpEnabled !== false && group.config.rounds && group.config.rounds.length) { %>
                      <div class="followup-schedule-preview-list mt-3">
                        <% group.config.rounds.forEach((round, idx) => { %>
                          <div class="followup-schedule-item">
                            <div class="schedule-order"><%= idx + 1 %></div>
                            <div class="schedule-detail">
                              <div class="schedule-time">+<%= formatDelay(round.delayMinutes) %></div>
                              <div class="schedule-message"><%= round.message || '' %></div>
                            </div>
                          </div>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="text-muted small mt-3">ยังไม่ได้ตั้งค่าข้อความติดตามสำหรับเพจนี้</div>
                    <% } %>
                  </div>

                  <div class="row g-3">
                    <% (group.users || []).forEach(user => { %>
                      <div class="col-12 col-lg-6">
                        <div class="followup-card h-100">
                          <div class="followup-card-header">
                            <div class="followup-avatar"><%= (user.displayName || user.userId || '?').charAt(0).toUpperCase() %></div>
                            <div class="followup-card-meta">
                              <div class="followup-name"><%= user.displayName || user.userId %></div>
                              <div class="followup-sub">
                                <%= user.userId %> •
                                <% if (user.platform === 'facebook') { %>
                                  <span class="badge bg-primary-soft text-primary"><i class="fab fa-facebook me-1"></i>Facebook</span>
                                <% } else { %>
                                  <span class="badge bg-success-soft text-success"><i class="fab fa-line me-1"></i>LINE</span>
                                <% } %>
                              </div>
                            </div>
                            <div class="followup-status-badge">
                              <span class="badge <%= statusBadgeClass(user.status) %>">
                                <i class="<%= statusIcon(user.status) %> me-1"></i><%= statusLabel(user.status) %>
                              </span>
                            </div>
                          </div>
                          <div class="followup-card-body">
                            <div class="followup-section">
                              <div class="label">ข้อความถัดไป</div>
                              <div class="value"><%= user.nextMessage || '-' %></div>
                              <div class="meta">
                                <% if (user.nextScheduledAt) { %>
                                  <%= formatDateTime(user.nextScheduledAt) %>
                                <% } else { %>
                                  ยังไม่มีนัดหมาย
                                <% } %>
                              </div>
                            </div>
                            <div class="followup-section">
                              <div class="label">ข้อความล่าสุดจากลูกค้า</div>
                              <div class="value"><%= user.lastUserMessagePreview || '-' %></div>
                              <div class="meta">
                                <% if (user.lastUserMessageAt) { %>
                                  <%= formatDateTime(user.lastUserMessageAt) %>
                                <% } else { %>
                                  -
                                <% } %>
                              </div>
                            </div>
                            <div class="followup-section">
                              <div class="label">ความคืบหน้า</div>
                              <div class="value"><%= (user.sentRounds || 0) %>/<%= user.totalRounds || 0 %> รอบ</div>
                              <div class="meta">
                                ส่งล่าสุด: <%= user.lastFollowUpAt ? formatDateTime(user.lastFollowUpAt) : 'ยังไม่เคยส่ง' %>
                              </div>
                            </div>
                            <div class="followup-section">
                              <div class="label">ตารางข้อความ</div>
                              <% if (user.rounds && user.rounds.length) { %>
                                <div class="followup-timeline">
                                  <% user.rounds.forEach((round, idx) => { %>
                                    <% const timelineStatus = round.status === 'sent' ? 'sent' : round.status === 'failed' ? 'failed' : (user.status === 'canceled' ? 'canceled' : 'pending'); %>
                                    <div class="followup-timeline-item <%= timelineStatus %>">
                                      <div class="timeline-dot"></div>
                                      <div class="timeline-body">
                                        <div class="timeline-header d-flex justify-content-between align-items-center">
                                          <span class="timeline-index">รอบที่ <%= idx + 1 %></span>
                                          <span class="timeline-status">
                                            <% if (round.status === 'sent') { %>ส่งแล้ว<% } else if (round.status === 'failed') { %>ส่งไม่สำเร็จ<% } else if (user.status === 'canceled') { %>ถูกยกเลิก<% } else { %>รอส่ง<% } %>
                                          </span>
                                        </div>
                                        <div class="timeline-time">
                                          <% if (round.sentAt) { %>
                                            ส่งเมื่อ <%= formatDateTime(round.sentAt) %>
                                          <% } else if (round.scheduledAt) { %>
                                            กำหนดส่ง <%= formatDateTime(round.scheduledAt) %>
                                          <% } else { %>
                                            หลัง +<%= formatDelay(round.delayMinutes) %>
                                          <% } %>
                                        </div>
                                        <div class="timeline-message"><%= round.message || '' %></div>
                                      </div>
                                    </div>
                                  <% }) %>
                                </div>
                              <% } else { %>
                                <div class="text-muted small">ยังไม่มีข้อมูลรอบติดตาม</div>
                              <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% }) %>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 

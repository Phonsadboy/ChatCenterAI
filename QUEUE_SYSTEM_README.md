# ระบบคิวข้อความและการดีเลย์ (Message Queue and Delay System)

## ภาพรวม

ระบบคิวข้อความถูกออกแบบมาเพื่อรวบรวมข้อความหลายข้อความจากผู้ใช้ก่อนที่จะส่งให้ AI ประมวลผล ซึ่งช่วยให้ AI สามารถเข้าใจบริบทของข้อความได้ดีขึ้นและลดการเรียก API ที่ไม่จำเป็น

## การทำงานของระบบ

### 1. การรับข้อความใหม่
- เมื่อผู้ใช้ส่งข้อความ ระบบจะเพิ่มข้อความนั้นเข้าคิวของผู้ใช้
- ระบบจะเริ่มนับเวลา delay ตามที่ตั้งไว้ใน `chatDelaySeconds`

### 2. การรอข้อความเพิ่ม
- ระบบจะรอข้อความเพิ่มจากผู้ใช้เป็นเวลา `chatDelaySeconds` วินาที
- หากมีข้อความใหม่เข้ามาในระหว่างนี้ ระบบจะรีเซ็ตตัวจับเวลาและรอใหม่
- ข้อความทั้งหมดจะถูกเก็บไว้ในคิวจนกว่าจะครบเวลา delay

### 3. การประมวลผลคิว
- เมื่อครบเวลา delay ระบบจะประมวลผลข้อความทั้งหมดในคิว
- หากจำนวนข้อความในคิวถึงขีดจำกัด `maxQueueMessages` ระบบจะประมวลผลทันทีโดยไม่รอเวลา delay

## การตั้งค่าที่เกี่ยวข้อง

### chatDelaySeconds
- **ค่าเริ่มต้น:** 5 วินาที
- **ช่วงที่แนะนำ:** 3-10 วินาที
- **การทำงาน:** ระยะเวลารอเพื่อรวมข้อความหลายข้อความเข้าด้วยกัน

### maxQueueMessages
- **ค่าเริ่มต้น:** 10 ข้อความ
- **ช่วงที่แนะนำ:** 5-15 ข้อความ
- **การทำงาน:** จำนวนข้อความสูงสุดที่จะรอรวมก่อนตอบกลับ

### enableMessageMerging
- **ค่าเริ่มต้น:** เปิดใช้งาน
- **การทำงาน:** รวมข้อความหลายข้อความเข้าด้วยกันด้วยเครื่องหมายขึ้นบรรทัดใหม่

## ตัวอย่างการทำงาน

### ตัวอย่างที่ 1: รอเวลา delay
```
เวลา 10:00:00 - ผู้ใช้ส่งข้อความ "สวัสดี"
เวลา 10:00:01 - ระบบเริ่มนับเวลา delay (5 วินาที)
เวลา 10:00:06 - ครบเวลา delay ระบบประมวลผลข้อความ "สวัสดี"
```

### ตัวอย่างที่ 2: มีข้อความเพิ่ม
```
เวลา 10:00:00 - ผู้ใช้ส่งข้อความ "สวัสดี"
เวลา 10:00:01 - ระบบเริ่มนับเวลา delay (5 วินาที)
เวลา 10:00:03 - ผู้ใช้ส่งข้อความ "คุณเป็นใคร"
เวลา 10:00:03 - ระบบรีเซ็ตตัวจับเวลาและรอใหม่ (5 วินาที)
เวลา 10:00:08 - ครบเวลา delay ระบบประมวลผลข้อความ "สวัสดี\n\nคุณเป็นใคร"
```

### ตัวอย่างที่ 3: ครบจำนวนข้อความ
```
เวลา 10:00:00 - ผู้ใช้ส่งข้อความ "ข้อความที่ 1"
เวลา 10:00:01 - ผู้ใช้ส่งข้อความ "ข้อความที่ 2"
...
เวลา 10:00:05 - ผู้ใช้ส่งข้อความ "ข้อความที่ 10" (ครบขีดจำกัด)
เวลา 10:00:05 - ระบบประมวลผลทันทีโดยไม่รอเวลา delay
```

## การตั้งค่าในหน้า Admin

### การเข้าถึง
1. เข้าสู่หน้า Admin Dashboard
2. เลือกแท็บ "การตั้งค่า"
3. เลือกแท็บ "การตั้งค่าแชท"

### การปรับแต่ง
- **เพิ่ม delay:** หากต้องการให้ระบบรอข้อความเพิ่มมากขึ้น
- **ลด delay:** หากต้องการการตอบกลับที่เร็วขึ้น
- **เพิ่มจำนวนข้อความในคิว:** หากต้องการรวมข้อความมากขึ้น
- **ลดจำนวนข้อความในคิว:** หากต้องการการตอบกลับที่บ่อยขึ้น

## ข้อดีของระบบ

1. **ลดการเรียก API:** รวมข้อความหลายข้อความเข้าด้วยกัน
2. **เข้าใจบริบทได้ดีขึ้น:** AI สามารถเห็นข้อความทั้งหมดพร้อมกัน
3. **ประหยัดต้นทุน:** ลดจำนวนการเรียก OpenAI API
4. **ประสบการณ์ผู้ใช้ที่ดีขึ้น:** ไม่มีการตอบกลับที่กระจัดกระจาย

## ข้อควรระวัง

1. **ไม่ควรตั้ง delay สูงเกินไป:** อาจทำให้ผู้ใช้รู้สึกว่าระบบช้า
2. **ไม่ควรตั้งจำนวนข้อความในคิวสูงเกินไป:** อาจทำให้การตอบกลับช้า
3. **ควรปรับแต่งตามพฤติกรรมผู้ใช้:** หากผู้ใช้มักส่งข้อความติดต่อกัน ควรลด delay

## การแก้ไขปัญหา

### ปัญหา: ระบบไม่รอข้อความเพิ่ม
**สาเหตุที่เป็นไปได้:**
- ค่า `chatDelaySeconds` ถูกตั้งเป็น 0 หรือต่ำเกินไป
- จำนวนข้อความในคิวถึงขีดจำกัด `maxQueueMessages`

**วิธีแก้ไข:**
1. ตรวจสอบการตั้งค่าในหน้า Admin
2. เพิ่มค่า `chatDelaySeconds` เป็น 3-5 วินาที
3. เพิ่มค่า `maxQueueMessages` เป็น 10-15 ข้อความ

### ปัญหา: ระบบรอนานเกินไป
**สาเหตุที่เป็นไปได้:**
- ค่า `chatDelaySeconds` ถูกตั้งสูงเกินไป

**วิธีแก้ไข:**
1. ลดค่า `chatDelaySeconds` เป็น 2-3 วินาที
2. ลดค่า `maxQueueMessages` เป็น 5-8 ข้อความ

## การตรวจสอบ Log

ระบบจะแสดง log ที่ชัดเจนเกี่ยวกับการทำงานของคิว:

```
[LOG] เพิ่มข้อมูลเข้าคิวสำหรับผู้ใช้: U123456789
[LOG] ตั้งเวลาประมวลผลคิวใน 5 วินาที สำหรับผู้ใช้: U123456789
[LOG] ระบบจะรอข้อความเพิ่มจากผู้ใช้เป็นเวลา 5 วินาที
[LOG] ครบเวลา delay (5 วินาที) เริ่มประมวลผลคิวสำหรับผู้ใช้: U123456789
[LOG] เริ่มการประมวลผลคิวสำหรับผู้ใช้: U123456789
```

หากต้องการตรวจสอบการทำงานของระบบ ให้ดู log เหล่านี้ใน Heroku logs หรือ console ของเซิร์ฟเวอร์

# üî¨ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å 360¬∞ ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡∏´‡∏•‡∏≠‡∏°‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå (Agent Forge)

> **‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:** 25 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026
> **Workspace:** `/Users/mac/pp/ChatCenterAI-6/`
> **‡πÇ‡∏î‡∏¢:** Principal Software Architect & Senior AI Engineer
> **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** Draft v1.1 ‚Äî Post-Review Update

---

## ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç

1. [‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Clarity & Architecture Alignment)](#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-1)
2. [‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå (System & Feature Improvements)](#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-2)
3. [‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 3: ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° (Feature Additions)](#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-3)
4. [‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 4: ‡∏à‡∏∏‡∏î‡∏ö‡∏≠‡∏î‡πÅ‡∏•‡∏∞ Edge Cases (Blind Spots & Risks)](#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-4)
5. [‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç](#‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
6. [‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô](#‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô)

---

## ‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Clarity & Architecture Alignment) {#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-1}

### üî¥ CRITICAL ‚Äî ‡∏à‡∏∏‡∏î‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î

#### 1.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Ç‡∏≠‡∏á `disableAiReply` ‡∏Å‡∏±‡∏ö `agent mode`

**‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô vs. ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô:**

- `index.js` ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î **5752**: `const disableAiReply = !!queueContext.disableAiReply;`
- `index.js` ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î **11500**: `const disableAiReply = !botIsActive;` (Facebook ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö `bot.status`)

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:** ‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ `disableAiReply` ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å "‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö `agent mode` ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á" ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ **‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Priority)** ‡πÄ‡∏°‡∏∑‡πà‡∏≠:
- Bot ‡∏¢‡∏±‡∏á `inactive` ‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà Agent mode ‡πÄ‡∏õ‡πá‡∏ô `ai-live-reply` ‚Üí ‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞?
- Bot `active` ‡πÅ‡∏ï‡πà Agent mode ‡πÄ‡∏õ‡πá‡∏ô `human-only` ‚Üí ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏¥‡∏î AI ‡∏ï‡∏≠‡∏ö

**‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠:** ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î **Priority Chain** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô:

```
‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: emergency_stop ‡∏à‡∏≤‡∏Å watchdog
‚Üì agent mode (human-only = disable)
‚Üì maintenance mode
‚Üì botIsActive
‚Üì userStatus.aiEnabled
‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ‡∏Ñ‡πà‡∏≤ default (‡∏ï‡∏≠‡∏ö AI)
```

---

#### 1.2 "Atomic Version Bump" ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠

‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏£‡∏∞‡∏ö‡∏∏ step 6 ‡∏ß‡πà‡∏≤ "apply ‡πÅ‡∏•‡πâ‡∏ß version bump ‡πÅ‡∏ö‡∏ö atomic" ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:
- ‡πÉ‡∏ä‡πâ MongoDB Transactions ‡∏´‡∏£‡∏∑‡∏≠ `findOneAndUpdate` ‡∏î‡πâ‡∏ß‡∏¢ version check?
- ‡∏ñ‡πâ‡∏≤ 2 runs ‡∏£‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (manual + scheduled) ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô instruction ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡∏à‡∏∞ handle ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ `instruction_chat_changelog` ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏î‡∏π‡∏à‡∏≤‡∏Å `instructionChatService.js` ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 16) ‚Äî Agent Forge ‡∏à‡∏∞ reuse ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á collection ‡πÉ‡∏´‡∏°‡πà?

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÉ‡∏ä‡πâ Optimistic Locking Pattern:

```javascript
// ‡πÉ‡∏ô agentForgeTools.js
await db.collection('instructions_v2').findOneAndUpdate(
  { _id: instructionId, version: currentVersion }, // condition
  { $inc: { version: 1 }, $set: { content: newContent, updatedAt: new Date() } },
  { returnDocument: 'after' }
);
// ‡∏ñ‡πâ‡∏≤ result === null = version conflict ‚Üí retry ‡∏´‡∏£‡∏∑‡∏≠ abort
```

---

#### 1.3 "Frontend Simulator Harness" ‚Äî ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£

‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏£‡∏∞‡∏ö‡∏∏ Phase C: "‡πÄ‡∏û‡∏¥‡πà‡∏° frontend simulator harness ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö customer-side test" ‡πÅ‡∏ï‡πà:
- Simulator ‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á LINE/Facebook webhook ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `processFlushedMessages` ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á?
- ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á webhook ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ mock ‡∏Ç‡∏≠‡∏á `line.Client` ‡πÅ‡∏•‡∏∞ Facebook Graph API
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `processFlushedMessages` ‡∏ï‡∏£‡∏á‡πÜ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á side effect ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ `self-test` ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô **internal test harness endpoint** ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á:

```
POST /api/agent-forge/internal/simulate-reply
  { pageKey, conversationScenario[] }
‚Üí Returns: AI reply, scoring, no side effect
```

---

### üü† HIGH ‚Äî Compatibility & Bottleneck Analysis

#### 1.4 `index.js` ‡∏Ç‡∏ô‡∏≤‡∏î 26,454 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‚Äî Monolith ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á Refactor

‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î** ‡πÉ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á Engineering:
- ‡πÑ‡∏ü‡∏•‡πå `index.js` ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ~914KB ‡∏°‡∏µ routes, business logic, DB queries, webhook handlers ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î
- ‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ "Reuse ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Express + EJS + SSE ‡πÄ‡∏î‡∏¥‡∏°" ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Agent Forge routes ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô `index.js` ‡πÄ‡∏î‡∏¥‡∏° ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 30‚Äì40%

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡∏™‡∏£‡πâ‡∏≤‡∏á Express Router ‡πÅ‡∏¢‡∏Å:

```javascript
// /routes/agentForge.js
const router = express.Router();
// ‡∏•‡∏á routes ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
module.exports = router;

// index.js
app.use('/api/agent-forge', require('./routes/agentForge'));
app.use('/admin/agent-forge', require('./routes/agentForgeAdmin'));
```

---

#### 1.5 MongoDB Collection Design ‚Äî ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ `agent_run_events` Seq Collision

Collection `agent_run_events` ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤ append-only ‡∏ã‡∏∂‡πà‡∏á‡∏î‡∏µ ‡πÅ‡∏ï‡πà:
- `seq` field: ‡πÅ‡∏ú‡∏ô‡∏Ø ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ generate seq ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ (MongoDB ObjectId? Atomic counter?)
- ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ `Date.now()` ‡πÄ‡∏õ‡πá‡∏ô seq ‚Üí ‡∏≠‡∏≤‡∏à collision ‡πÄ‡∏°‡∏∑‡πà‡∏≠ events ‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÉ‡∏ä‡πâ Atomic Counter ‡∏ï‡πà‡∏≠ runId:

```javascript
// ‡πÉ‡∏ô agentForgeRunner.js
async function nextSeq(runId) {
  const result = await db.collection('agent_runs').findOneAndUpdate(
    { _id: runId },
    { $inc: { _seqCounter: 1 } },
    { returnDocument: 'after' }
  );
  return result._seqCounter;
}
```

---

#### 1.6 Cursor Incremental ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á Transaction Boundary

‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏£‡∏∞‡∏ö‡∏∏ "commit cursor ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ run ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" ‡πÅ‡∏ï‡πà:
- ‡∏ñ‡πâ‡∏≤ run publish instruction ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà cursor commit fail ‚Üí run ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞ reprocess ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‚Üí instruction ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å publish ‡∏ã‡πâ‡∏≥

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÉ‡∏ä‡πâ MongoDB **Session Transactions** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `publish_instruction + cursor_commit` ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô atomic operation ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

---

## ‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå (System & Feature Improvements) {#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-2}

### ÔøΩ HIGH ‚Äî Tool Contracts & API Surface

#### 2.1 `get_customer_conversation` Tool ‚Äî ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Unbounded Payload

‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó 500 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí tool return ‡∏≠‡∏≤‡∏à‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏Å‡∏¥‡∏ô context window ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà **20 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î** ‡πÄ‡∏™‡∏°‡∏≠:

```javascript
// ‡πÉ‡∏ô agentForgeTools.js
get_customer_conversation(customerId, {
  maxMessages: 20,         // 20 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  includeAdminReplies: true // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö baseline scoring
})
```

---

#### 2.2 Scoring ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Baseline ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏¥‡∏¢‡∏≤‡∏° Scoring Formula

`agentForgeScorer.js` ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏ï‡πà‡πÅ‡∏ú‡∏ô‡∏Ø ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ Rubric ‡πÄ‡∏•‡∏¢

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Scoring Rubric:**

| Dimension | Weight | ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ß‡∏±‡∏î |
|---|---|---|
| Task Completion | 30% | AI ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å sub-question? |
| Factual Accuracy | 25% | ‡πÑ‡∏°‡πà‡∏°‡∏µ field ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô KB? |
| Tone & Style | 15% | Similarity ‡∏Å‡∏±‡∏ö admin baseline |
| Response Length | 10% | ‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô |
| No Hallucination | 20% | ‡πÑ‡∏°‡πà‡∏°‡∏µ invented data |

---

#### 2.3 Tool `reason` Field ‡πÑ‡∏°‡πà‡∏°‡∏µ Schema ‡∏Å‡∏≥‡∏´‡∏ô‡∏î

‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏ó‡∏∏‡∏Å write tool ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ `reason`" ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î max length, required/optional, ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô audit log

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Tool Contract Standard:**

```typescript
interface WriteToolBase {
  reason: string;      // required, max 500 chars, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å journal
  dryRun?: boolean;    // default false
  requestId?: string;  // trace back ‡∏ñ‡∏∂‡∏á run
}
```

---

## ‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 3: ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° (Feature Additions) {#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-3}

### üü° ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (UX & Observability)

#### 3.1 üÜï "Agent Health Dashboard" ‚Äî ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

‡∏´‡∏ô‡πâ‡∏≤ `/admin/agent-forge` ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ **Health Card** ‡∏ï‡πà‡∏≠ agent:

```
‚îå‚îÄ Agent: ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏° Premium ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Mode: üî¥ HUMAN-ONLY     Last Run: 2h ago       ‚îÇ
‚îÇ Current Score: 87.3%   Baseline: 82.1% (+6.3%) ‚îÇ
‚îÇ Open Conversations: 243  Ghost Rate: 12%        ‚îÇ
‚îÇ [Process Now] [View Last Run] [Switch to Live]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

#### 3.2 üÜï "Instruction Diff Viewer" ‚Äî ‡∏Å‡πà‡∏≠‡∏ô/‡∏´‡∏•‡∏±‡∏á Patch

‡πÄ‡∏°‡∏∑‡πà‡∏≠ agent patch instruction ‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á diff ‡πÅ‡∏ö‡∏ö GitHub PR:

```diff
- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏£‡∏≤‡∏Ñ‡∏≤ X ‡∏ö‡∏≤‡∏ó (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 3 ‡∏ä‡∏¥‡πâ‡∏ô)
+ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏£‡∏≤‡∏Ñ‡∏≤ X ‡∏ö‡∏≤‡∏ó (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1 ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏ã‡∏∑‡πâ‡∏≠ 3 ‡∏•‡∏î 10%)
  (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å: Admin reply ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 24/02/2026 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ @userId123)
```

---

#### 3.3 üÜï "Confidence Score Ring" ‡πÉ‡∏ô Run UI

‡πÅ‡∏ï‡πà‡∏•‡∏∞ self-test case ‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á visual confidence ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà pass/fail:

```
Case: ‡∏Ç‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô/QR
Score: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 82% | Status: ‚úÖ PASS (threshold: 80%)
Reason: ‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‚úì ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£ offer QR ‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 2 turns
```

---

### üü° ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (Business)

#### 3.4 üÜï "Conversion Lift Attribution" ‚Äî ‡∏ß‡∏±‡∏î ROI ‡∏Ç‡∏≠‡∏á Agent

‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏µ `conversation_threads` ‡∏ó‡∏µ‡πà track `outcome: purchased/not_purchased` ‡πÅ‡∏•‡πâ‡∏ß (‡∏î‡∏π `conversationThreadService.js` ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 172‚Äì178) Agent Forge ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°:

```javascript
// ‡πÉ‡∏ô agent_runs collection
conversionMetrics: {
  weekBeforeRun: { conversionRate: 0.18, avgOrderValue: 850 },
  weekAfterRun:  { conversionRate: 0.24, avgOrderValue: 920 },
  lift: { conversionRate: '+33%', revenue: '+8.2%' }
}
```

---

### üü° ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤ (Developer Experience)

#### 3.5 üÜï "Full Run Dry Mode" ‚Äî ‡∏Ç‡∏≤‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô

‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏ö‡∏≠‡∏Å `dryRun=true` ‡∏ï‡πà‡∏≠ tool ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ **Full Run Dry Mode** ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô orchestration ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà publish:

```
POST /api/agent-forge/agents/:agentId/run
{ "dryRun": true }

‚Üí ‡∏£‡∏±‡∏ô orchestration loop ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å step
‚Üí ‡πÅ‡∏™‡∏î‡∏á scoring, patch preview, decisions
‚Üí ‡πÑ‡∏°‡πà publish, ‡πÑ‡∏°‡πà commit cursor, ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å event ‡∏à‡∏£‡∏¥‡∏á
‚Üí ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CI/CD testing
```

---

#### 3.6 üÜï "Tool Call Replay" ‚Äî Debug ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Step

‡πÄ‡∏°‡∏∑‡πà‡∏≠ agent ‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà tool call ‡∏ó‡∏µ‡πà 7 ‡∏Ñ‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ replay ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ step ‡∏ô‡∏±‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:

```
POST /api/agent-forge/runs/:runId/replay-from-event/:seq
‚Üí ‡πÉ‡∏™‡πà context ‡∏à‡∏≤‡∏Å event seq ‡∏ô‡∏±‡πâ‡∏ô ‚Üí ‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô
```

---

## ‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà 4: ‡∏à‡∏∏‡∏î‡∏ö‡∏≠‡∏î‡πÅ‡∏•‡∏∞ Edge Cases (Blind Spots & Risks) {#‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà-4}

### üî¥ CRITICAL

#### 4.1 üï≥Ô∏è Concurrent Run Lock ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Implementation

‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏£‡∏∞‡∏ö‡∏∏ "1 active run ‡∏ï‡πà‡∏≠ 1 agent" ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡∏Å‡∏•‡πÑ‡∏Å lock ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ `agent_profiles.status = "running"` ‚Üí **Race condition** ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤ request 2 ‡∏ï‡∏±‡∏ß‡∏≠‡πà‡∏≤‡∏ô status ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: Atomic Upsert Lock**

```javascript
const lockResult = await db.collection('agent_profiles').findOneAndUpdate(
  { _id: agentId, status: { $ne: 'running' } }, // atomic condition
  { $set: { status: 'running', runLockedAt: new Date() } },
  { returnDocument: 'after' }
);
if (!lockResult) throw new Error('Agent already running ‚Äî concurrent lock rejected');
```

‡πÄ‡∏û‡∏¥‡πà‡∏° **Stale Lock Detector**: ‡∏ñ‡πâ‡∏≤ `runLockedAt` > 4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‚Üí auto-release (dead process)

---

#### 4.2 üï≥Ô∏è Context Compaction ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Traceability

‡∏ñ‡πâ‡∏≤ compaction ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Tool results ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å summarize ‚Üí Agent ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢ query customer X ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏≠‡∏≤‡∏à re-query customer ‡πÄ‡∏î‡∏¥‡∏°

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: Compaction Manifest**

```javascript
// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô compact ‡πÅ‡∏•‡πâ‡∏ß inject ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ context ‡∏´‡∏•‡∏±‡∏á compact
compactionManifest = {
  customersProcessed: ['userId1', 'userId2', ...],
  toolCallsSummary: {
    list_customers_batch: 5,
    get_customer_conversation: 47
  },
  lastProcessedCursor: '2026-02-24T23:59:00Z'
}
```

---

#### 4.3 üï≥Ô∏è SSE Reconnect ‚Äî Event Buffer Memory Leak

‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î SSE ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (`activeRequests` Map ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 18974‚Äì18980 ‡πÉ‡∏ô `index.js`) Events ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô memory ‡∏ï‡∏•‡∏≠‡∏î Agent run ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏°‡∏µ events ‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏±‡∏ô ‚Üí memory ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Agent Forge Run (Long-lived):**

```javascript
// ‡πÉ‡∏ä‡πâ MongoDB ‡πÄ‡∏õ‡πá‡∏ô event buffer ‡πÅ‡∏ó‡∏ô in-memory
// (agent_run_events collection ‡∏°‡∏µ‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏Ñ‡∏ß‡∏£ enforce ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ DB)
GET /api/agent-forge/runs/:runId/events?afterSeq=450
‚Üí Stream events ‡∏à‡∏≤‡∏Å DB ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà seq 451+
```

> ‚ö†Ô∏è `agent_run_events` collection ‡∏°‡∏µ‡πÉ‡∏ô Data Model ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏ß‡∏£ **enforce ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ DB ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà in-memory** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Agent Forge ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞

---

#### 4.4 üï≥Ô∏è LINE Bot `reject bot inactive` ‡∏Å‡∏±‡∏ö Agent Mode

‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î `index.js` ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 11500: `const disableAiReply = !botIsActive;`

‡∏£‡∏∞‡∏ö‡∏ö LINE ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô **‡πÄ‡∏ä‡πá‡∏Ñ `botIsActive` ‡∏Å‡πà‡∏≠‡∏ô** ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à ‡πÅ‡∏ï‡πà‡πÅ‡∏ú‡∏ô‡∏Ø ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ "inject `disableAiReply=true` ‡πÄ‡∏Ç‡πâ‡∏≤ queueContext":
- `botIsActive=false` ‚Üí **‡πÑ‡∏°‡πà queue ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡∏¢** (‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏°)
- Agent `human-only` ‚Üí **queue ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö** (‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà)
- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ **‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô** ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ LINE webhook handler ‡∏î‡πâ‡∏ß‡∏¢

**‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Logic ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:**

```javascript
// LINE webhook handler ‡πÉ‡∏´‡∏°‡πà
const agentMode = await getAgentModeForPage(linePageKey); // 'human-only' | 'ai-live-reply'
const botIsActive = lineBot.status === 'active';

// bot ‡∏ï‡πâ‡∏≠‡∏á "appear active" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏ï‡πà AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö
const effectiveActive = botIsActive || (agentMode === 'human-only');
const disableAiReply = !botIsActive || agentMode === 'human-only';
```

---

#### 4.5 üï≥Ô∏è `_pendingBulkDeletes` Memory Leak ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°

‡∏û‡∏ö‡πÉ‡∏ô `instructionChatService.js` ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 534:

```javascript
this._pendingBulkDeletes = this._pendingBulkDeletes || {};
```

‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô in-memory object ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠ confirmToken ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‚Üí accumulate ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏≤‡∏ô Agent Forge ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ pattern ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£ fix ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢

---

## ‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç {#‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç}

| Priority | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Issue | Action |
|---|---|---|
| üî¥ **CRITICAL** | 4 | ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô Phase A ‡πÄ‡∏£‡∏¥‡πà‡∏° |
| üü† **HIGH** | 5 | ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô Phase C |
| üü° **MEDIUM** | 6 | Feature additions ‡∏ó‡∏≥‡πÉ‡∏ô Phase ‡∏ó‡πâ‡∏≤‡∏¢ |
| üü¢ **LOW** | Memory leaks | Technical debt ‡πÅ‡∏Å‡πâ‡πÉ‡∏ô Phase G |

### Issue Summary Matrix

| # | Issue | Priority | Phase ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö | ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á |
|---|---|---|---|---|
| 1.1 | `disableAiReply` Priority Chain | üî¥ CRITICAL | Phase E | `index.js:5752, 11500` |
| 1.2 | Atomic Version Bump | üî¥ CRITICAL | Phase C | `instructionChatService.js:16` |
| 1.3 | Frontend Simulator ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î | üî¥ CRITICAL | Phase C | ‚Äî |
| 1.4 | index.js Monolith | üü† HIGH | Phase A | `index.js` |
| 1.5 | Seq Counter Collision | üü† HIGH | Phase B | `agent_run_events` |
| 1.6 | Cursor-Publish Transaction | üü† HIGH | Phase B | `agent_processing_cursors` |
| 2.1 | Unbounded Tool Payload (20 msg cap) | ÔøΩ HIGH | Phase B | `agentForgeTools.js` |
| 2.2 | Scoring Rubric ‡πÑ‡∏°‡πà‡∏°‡∏µ | üü† HIGH | Phase C | `agentForgeScorer.js` |
| 4.1 | Concurrent Run Lock | üî¥ CRITICAL | Phase A | `agent_profiles` |
| 4.2 | Compaction Manifest | ÔøΩ HIGH (‡πÅ‡∏Å‡πâ‡πÉ‡∏ô Phase B) | Phase B | `agentForgeRunner.js` |
| 4.3 | SSE Memory Leak | üü† HIGH | Phase D | `agent_run_events` |
| 4.4 | LINE Bot mode conflict | üî¥ CRITICAL | Phase E | `index.js:11500` |

---

## ‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ‚Äî ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° Phase A {#‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô}

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô

1. **‡∏™‡∏£‡πâ‡∏≤‡∏á `routes/agentForge.js` router** ‚Äî ‡πÑ‡∏°‡πà‡∏¢‡∏±‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô `index.js` (‡πÅ‡∏Å‡πâ Monolith risk)
2. **‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Priority Chain spec** ‡∏Ç‡∏≠‡∏á `disableAiReply` ‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏´‡∏ô‡πâ‡∏≤ document ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô code
3. **‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Atomic Lock** ‡πÉ‡∏ô `agent_profiles` ‡∏î‡πâ‡∏ß‡∏¢ `findOneAndUpdate` + `runLockedAt` stale check
4. **‡∏Å‡∏≥‡∏´‡∏ô‡∏î Scoring Rubric** ‡∏ó‡∏±‡πâ‡∏á 5 dimensions ‡∏Å‡πà‡∏≠‡∏ô implement `agentForgeScorer.js`
5. **‡∏¢‡πâ‡∏≤‡∏¢ SSE event buffer** ‡πÑ‡∏õ `agent_run_events` (MongoDB) ‡πÅ‡∏ó‡∏ô in-memory `activeRequests` Map
6. **‡∏Å‡∏≥‡∏´‡∏ô‡∏î `maxMessages: 20`** ‡πÉ‡∏ô `get_customer_conversation` tool contract ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô

### Recommended File Structure

```
/Users/mac/pp/ChatCenterAI-6/
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ agentForge.js          ‚Üê API routes (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ agentForgeAdmin.js     ‚Üê Admin UI routes (NEW)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ agentForgeRunner.js    ‚Üê Orchestration loop (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ agentForgeTools.js     ‚Üê Tool contracts (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ agentForgeScorer.js    ‚Üê Scoring engine (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ agentForgeScheduler.js ‚Üê Cron scheduler (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ agentForgeService.js   ‚Üê Profile CRUD (NEW)
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îú‚îÄ‚îÄ admin-agent-forge.ejs     ‚Üê Control panel (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ admin-agent-forge-run.ejs ‚Üê Trace UI (NEW)
‚îî‚îÄ‚îÄ public/
    ‚îú‚îÄ‚îÄ js/
    ‚îÇ   ‚îú‚îÄ‚îÄ agent-forge.js     (NEW)
    ‚îÇ   ‚îî‚îÄ‚îÄ agent-forge-run.js (NEW)
    ‚îî‚îÄ‚îÄ css/
        ‚îú‚îÄ‚îÄ agent-forge.css    (NEW)
        ‚îî‚îÄ‚îÄ agent-forge-run.css (NEW)
```

---

> **‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô:** ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô Agent Forge ‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ **Concurrent Run Lock** (4.1) ‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡πâ‡∏≤ implement ‡∏ú‡∏¥‡∏î‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ instruction ‡∏ñ‡∏π‡∏Å publish ‡∏ã‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞ **LINE Bot mode conflict** (4.4) ‡∏ã‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ webhook handler ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πâ bot inactive ‡∏Ñ‡∏ß‡∏£ address ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° implementation ‡∏ó‡∏∏‡∏Å Phase

---

*‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ AI Analysis ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ö‡∏™‡∏à‡∏£‡∏¥‡∏á ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 25 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026 | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï v1.1 ‡∏ï‡∏≤‡∏° review ‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á*
